<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Recipe Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #e9e5f3; 
            background-image: url("https://www.transparenttextures.com/patterns/food.png"); 
            color: #334155; 
        }
        .app-section { background-color: #fcfaf2; border-radius: 20px; padding: 24px; border: 1px solid #f0ede4; transition: all 0.3s ease; }
        .drag-row { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; margin-bottom: 4px; transition: all 0.2s; }
        .sortable-ghost { opacity: 0.1; background: #a78bfa !important; }
        .drag-handle { cursor: grab; color: #d1d5db; padding: 4px; }
        
        .section-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }
        .section-collapsed {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
        }

        .photo-card {
            aspect-ratio: 1/1;
            background: white;
            padding: 10px 10px 30px 10px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            transform: rotate(-1deg);
            transition: transform 0.2s;
        }
        .photo-card:hover { transform: rotate(0deg) scale(1.02); }

        /* Step Highlighting */
        .step-active { border-color: #a78bfa !important; background: white !important; box-shadow: 0 10px 15px -3px rgba(167, 139, 250, 0.1); }
        .step-done { opacity: 0.5; filter: grayscale(1); }

        @media print {
            .no-print { display: none !important; }
            .section-collapsed { max-height: none !important; opacity: 1 !important; }
            .card { box-shadow: none !important; border: none !important; padding: 0 !important; background: white !important; }
            body { background: white !important; }
            .app-section { background: white !important; border: none !important; padding: 0 !important; }
        }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-[1550px] mx-auto p-6 md:p-10">
    <div class="flex flex-wrap justify-between items-center mb-8 gap-4 no-print bg-white/90 backdrop-blur-md p-5 rounded-2xl shadow-xl border border-white/50">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-4">
                <button @click="saveRecipe" class="hover:text-purple-600 transition-colors" title="Save to File"><i class="ph ph-floppy-disk text-2xl"></i></button>
                <button @click="$refs.fileInput.click()" class="hover:text-purple-600 transition-colors" title="Load File"><i class="ph ph-folder-open text-2xl"></i></button>
                <button @click="resetRecipe" class="hover:text-red-500 transition-colors" title="New Recipe"><i class="ph ph-arrow-counter-clockwise text-2xl"></i></button>
                <input type="file" ref="fileInput" @change="loadRecipe" accept=".json" class="hidden">
            </div>
            <div class="h-8 w-px bg-slate-200"></div>
            
            <div class="flex items-center gap-3">
                <div class="flex flex-col">
                    <span class="text-[10px] uppercase font-bold text-slate-400">Scale Yield</span>
                    <div class="relative inline-block">
                        <select v-model="scale" class="appearance-none bg-slate-100 border-none rounded-lg py-1 pl-3 pr-8 text-sm font-bold text-purple-700 cursor-pointer focus:ring-2 focus:ring-purple-300">
                            <option v-for="s in [0.25, 0.33, 0.5, 1, 2, 3, 4, 5]" :value="s">{{ s === 1 ? 'Full (1x)' : s + 'x' }}</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-purple-700">
                            <i class="ph ph-caret-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex gap-2 mr-4">
                <button @click="toggleAll(false)" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" title="Collapse All"><i class="ph ph-arrows-in-simple text-xl text-slate-400"></i></button>
                <button @click="toggleAll(true)" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" title="Expand All"><i class="ph ph-arrows-out-simple text-xl text-slate-400"></i></button>
            </div>
            <div class="flex bg-slate-100 p-1 rounded-lg">
                <button @click="unitSystem = 'metric'" :class="unitSystem === 'metric' ? 'bg-white shadow-sm text-purple-600' : 'text-slate-500'" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all">Metric</button>
                <button @click="unitSystem = 'imperial'" :class="unitSystem === 'imperial' ? 'bg-white shadow-sm text-purple-600' : 'text-slate-500'" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all">Imperial</button>
            </div>
            <button onclick="window.print()" class="ml-4 p-2 hover:bg-white rounded-full transition-colors"><i class="ph ph-printer text-2xl text-slate-400 hover:text-black"></i></button>
        </div>
    </div>

    <div class="card bg-white shadow-2xl rounded-[40px] p-10 md:p-16 border border-white/50 relative overflow-hidden">
        <div class="flex flex-col md:flex-row items-start md:items-center gap-6 mb-12">
            <div class="relative no-print group">
                <div class="w-20 h-20 bg-purple-100 rounded-2xl flex items-center justify-center text-purple-500 text-4xl shadow-inner">
                    <i :class="categories.find(c => c.name === selectedCategory)?.icon || 'ph ph-cooking-pot'"></i>
                </div>
                <select v-model="selectedCategory" class="absolute inset-0 opacity-0 cursor-pointer">
                    <option v-for="cat in categories" :key="cat.name" :value="cat.name">{{ cat.name }}</option>
                </select>
            </div>
            <div class="flex flex-grow flex-col">
                <span class="text-purple-400 font-bold uppercase tracking-[0.2em] text-xs ml-1">Recipe for...</span>
                <input v-model="recipeTitle" placeholder="Untitled Recipe" class="text-5xl font-black w-full focus:outline-none border-b-2 border-transparent focus:border-purple-300 pb-2 transition-all bg-transparent">
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <div class="space-y-10">
                <section class="app-section">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-200 pb-3 cursor-pointer group" @click="ui.showIng = !ui.showIng">
                        <div class="flex items-center gap-3">
                            <i class="ph text-xl text-purple-400 transition-transform" :class="ui.showIng ? 'ph-caret-down' : 'ph-caret-right'"></i>
                            <h2 class="text-xs font-black uppercase tracking-widest text-slate-400">Ingredients</h2>
                        </div>
                        <div class="flex gap-4 no-print" v-show="ui.showIng">
                            <button @click.stop="addIngredient(false)" class="text-purple-600 text-xs font-black hover:underline">+ ITEM</button>
                            <button @click.stop="addIngredient(true)" class="text-slate-400 text-xs font-black hover:underline">+ HEADER</button>
                        </div>
                    </div>
                    <div :class="{'section-collapsed': !ui.showIng}" class="section-content">
                        <div id="ingredient-list">
                            <div v-for="(ing, index) in ingredients" :key="ing.id" class="drag-row group" :class="{'mt-6 mb-2 border-b border-slate-100': ing.isHeader}">
                                <i class="ph ph-dots-six-vertical drag-handle text-xl no-print"></i>
                                
                                <template v-if="ing.isHeader">
                                    <input v-model="ing.name" placeholder="Section Header (e.g. The Sauce)" class="flex-grow font-black text-sm uppercase tracking-widest text-purple-900 bg-transparent outline-none">
                                </template>
                                
                                <template v-else>
                                    <input type="checkbox" class="w-5 h-5 rounded-full border-2 border-purple-200 text-purple-600 focus:ring-purple-500 no-print">
                                    <div class="w-20 text-right font-mono font-bold text-lg text-purple-600">{{ isQualitative(ing.unit) ? '' : calculateAmount(ing.amount, ing.unit) }}</div>
                                    <div :class="isQualitative(ing.unit) ? 'w-36' : 'w-16'" class="text-sm font-black text-slate-800 uppercase">{{ getDisplayUnit(ing.unit) }}</div>
                                    <input v-model="ing.name" placeholder="Ingredient..." class="flex-grow text-base outline-none bg-transparent border-b border-transparent focus:border-purple-200">
                                    
                                    <div class="flex items-center gap-2 no-print opacity-0 group-hover:opacity-100 transition-opacity">
                                        <select v-model="ing.unit" class="text-[10px] font-bold bg-white border rounded p-1 uppercase">
                                            <optgroup label="Measurements"><option v-for="u in ['g','kg','ml','l','cup','tbsp','tsp','pcs']" :value="u">{{u}}</option></optgroup>
                                            <optgroup label="Qualitative"><option value="pinch">Pinch</option><option value="to taste">To Taste</option><option value="a bit">A Bit</option></optgroup>
                                        </select>
                                        <input v-if="!isQualitative(ing.unit)" type="number" step="any" v-model.number="ing.amount" class="w-12 text-[10px] text-center border bg-white rounded p-1">
                                    </div>
                                </template>
                                <button @click="ingredients.splice(index, 1)" class="text-red-300 hover:text-red-500 no-print"><i class="ph ph-trash text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="app-section">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-200 pb-3 cursor-pointer group" @click="ui.showMise = !ui.showMise">
                        <div class="flex items-center gap-3">
                            <i class="ph text-xl text-purple-400 transition-transform" :class="ui.showMise ? 'ph-caret-down' : 'ph-caret-right'"></i>
                            <h2 class="text-xs font-black uppercase tracking-widest text-slate-400">Mise en Place</h2>
                        </div>
                        <button v-show="ui.showMise" @click.stop="addMise" class="text-purple-600 text-xs font-black no-print hover:underline">+ ADD PREP</button>
                    </div>
                    <div :class="{'section-collapsed': !ui.showMise}" class="section-content">
                        <div id="mise-list">
                            <div v-for="(item, index) in miseEnPlace" :key="item.id" class="drag-row group">
                                <i class="ph ph-dots-six-vertical drag-handle text-xl no-print"></i>
                                <input v-model="item.technique" placeholder="Technique" class="w-1/3 font-bold text-base outline-none bg-transparent border-b border-transparent focus:border-purple-200">
                                <input v-model="item.description" placeholder="Prep details..." class="flex-grow text-base text-slate-500 outline-none bg-transparent">
                                <button @click="miseEnPlace.splice(index, 1)" class="no-print opacity-0 group-hover:opacity-100 text-red-300 hover:text-red-500"><i class="ph ph-x-circle text-xl"></i></button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="space-y-10">
                <section class="app-section">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-200 pb-3 cursor-pointer group" @click="ui.showMethod = !ui.showMethod">
                        <div class="flex items-center gap-3">
                            <i class="ph text-xl text-purple-400 transition-transform" :class="ui.showMethod ? 'ph-caret-down' : 'ph-caret-right'"></i>
                            <h2 class="text-xs font-black uppercase tracking-widest text-slate-400">Method</h2>
                        </div>
                        <button v-show="ui.showMethod" @click.stop="addMethod" class="text-purple-600 text-xs font-black no-print hover:underline">+ ADD STEP</button>
                    </div>
                    <div :class="{'section-collapsed': !ui.showMethod}" class="section-content">
                        <div id="method-list">
                            <div v-for="(step, index) in method" :key="step.id" 
                                 class="flex gap-4 mb-6 group items-start p-4 rounded-2xl transition-all border-2 border-transparent"
                                 :class="{'step-active': activeStep === index, 'step-done': step.done}">
                                
                                <i class="ph ph-dots-six-vertical drag-handle text-xl mt-1 no-print"></i>
                                <div class="flex flex-col items-center">
                                    <span class="text-3xl font-black text-slate-200 w-8">{{ index + 1 }}</span>
                                    <input type="checkbox" v-model="step.done" class="mt-2 no-print">
                                </div>
                                
                                <textarea v-model="step.text" 
                                          @focus="activeStep = index"
                                          rows="2" 
                                          class="flex-grow text-base leading-relaxed p-2 bg-transparent outline-none resize-none transition-all"
                                          placeholder="Describe the step..."></textarea>
                                
                                <button @click="method.splice(index, 1)" class="no-print opacity-0 group-hover:opacity-100 text-red-300 mt-1"><i class="ph ph-trash text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="app-section">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-200 pb-3 cursor-pointer group" @click="ui.showGallery = !ui.showGallery">
                        <div class="flex items-center gap-3">
                            <i class="ph text-xl text-purple-400 transition-transform" :class="ui.showGallery ? 'ph-caret-down' : 'ph-caret-right'"></i>
                            <h2 class="text-xs font-black uppercase tracking-widest text-slate-400">Dish Gallery</h2>
                        </div>
                        <button v-show="ui.showGallery" @click.stop="$refs.imageInput.click()" class="text-purple-600 text-xs font-black no-print hover:underline">+ ADD PHOTO</button>
                        <input type="file" ref="imageInput" multiple accept="image/*" class="hidden" @change="handleImageUpload">
                    </div>
                    <div :class="{'section-collapsed': !ui.showGallery}" class="section-content">
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-6">
                            <div v-for="(img, index) in images" :key="index" class="relative group">
                                <div class="photo-card">
                                    <img :src="img" class="w-full h-full object-cover">
                                </div>
                                <button @click="images.splice(index, 1)" class="no-print absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i class="ph ph-x text-xs"></i>
                                </button>
                            </div>
                            <div v-if="images.length === 0" class="col-span-full py-10 text-center border-2 border-dashed border-slate-200 rounded-xl text-slate-400">
                                <i class="ph ph-image text-4xl mb-2"></i>
                                <p class="text-sm">Add photos to showcase your dish!</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="app-section !bg-amber-50/40 border-amber-100/50">
                    <div class="flex items-center gap-3 mb-4 border-b border-amber-100 pb-2 cursor-pointer" @click="ui.showNotes = !ui.showNotes">
                        <i class="ph text-xl text-amber-400 transition-transform" :class="ui.showNotes ? 'ph-caret-down' : 'ph-caret-right'"></i>
                        <h2 class="text-xs font-black uppercase tracking-widest text-amber-600/50">Chef's Notes</h2>
                    </div>
                    <div :class="{'section-collapsed': !ui.showNotes}" class="section-content">
                        <textarea v-model="notes" placeholder="Storage, plating, or pairing notes..." class="w-full h-40 p-2 text-base leading-relaxed bg-transparent outline-none resize-none"></textarea>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, nextTick } = Vue;

const DEFAULT_STATE = {
    recipeTitle: '',
    scale: 1,
    unitSystem: 'metric',
    selectedCategory: 'Mains',
    ui: { showIng: true, showMise: true, showMethod: true, showNotes: true, showGallery: true },
    ingredients: [{ id: 1, amount: 0, unit: 'g', name: '', isHeader: false }],
    miseEnPlace: [{ id: 2, technique: '', description: '' }],
    method: [{ id: 3, text: '', done: false }],
    images: [],
    notes: '',
    activeStep: null
};

createApp({
    data() {
        return {
            ...JSON.parse(JSON.stringify(DEFAULT_STATE)),
            categories: [
                { name: 'Cakes', icon: 'ph ph-cake' }, { name: 'Soups', icon: 'ph ph-bowl-steam' },
                { name: 'Desserts', icon: 'ph ph-ice-cream' }, { name: 'Mains', icon: 'ph ph-cooking-pot' },
                { name: 'Sweets', icon: 'ph ph-cookie' }, { name: 'Savoury', icon: 'ph ph-pizza' },
                { name: 'Snacks', icon: 'ph ph-popcorn' }, { name: 'Baking', icon: 'ph ph-bread' },
                { name: 'Frying', icon: 'ph ph-egg' }, { name: 'Sandwiches', icon: 'ph ph-hamburger' }
            ]
        }
    },
    watch: {
        '$data': {
            handler() { this.saveToLocal(); },
            deep: true
        }
    },
    mounted() {
        const saved = localStorage.getItem('current_recipe');
        if (saved) Object.assign(this, JSON.parse(saved));
        
        this.initSortable('ingredient-list', 'ingredients');
        this.initSortable('method-list', 'method');
        this.initSortable('mise-list', 'miseEnPlace');
    },
    methods: {
        saveToLocal() {
            localStorage.setItem('current_recipe', JSON.stringify(this.$data));
        },
        resetRecipe() {
            if(confirm('Clear current recipe and start fresh?')) {
                Object.assign(this, JSON.parse(JSON.stringify(DEFAULT_STATE)));
                localStorage.removeItem('current_recipe');
            }
        },
        toggleAll(state) { Object.keys(this.ui).forEach(key => this.ui[key] = state); },
